{% extends "layout.html" %}
{% block title %}HXTool - Enterprise Search{% endblock %}
{% block navlocation %}Enterprise Search{% endblock %}
{% block content %}

<script>

	function guid() {
	    function _p8(s) {
	        var p = (Math.random().toString(16)+"000000000").substr(2,8);
	        return s ? "-" + p.substr(0,4) + "-" + p.substr(4,4) : p ;
	    }
    	return _p8() + _p8(true) + _p8(true) + _p8();
	}

	function enableStore() {
			$("#checkboxStore").prop('checked', true);
			$("#divStore").css("background", "rgb(225,225,225)");
			$("#divFile").css("background", "rgb(242,242,242)");
			$("#checkboxFile").prop('checked', false);
	}

	function enableFile() {
			$("#checkboxFile").prop('checked', true);
			$("#divFile").css("background", "rgb(225,225,225)");
			$("#divStore").css("background", "rgb(242,242,242)");		
			$("#checkboxStore").prop('checked', false);
	}

	function renderInterval(intervalType) {

		out = "";

		if (intervalType == "month") {
			out += " on the ";
			out += "<select name='intervalDay'>";
			for (var i=1; i < 32; i += 1){
				out += "<option value='" + i + "'>" + i;
			}
			out += "</select>";
			out += " ";
		}

		if (intervalType == "week") {
			out += " on ";
			out += "<select name='intervalWeek'>";
			out += "<option value='0'>Monday";
			out += "<option value='1'>Tuesday";
			out += "<option value='2'>Wednesday";
			out += "<option value='3'>Thursday";
			out += "<option value='4'>Friday";
			out += "<option value='5'>Saturday";
			out += "<option value='6'>Sunday";
			out += "</select>";
			out += " ";
		}

		if (intervalType == "day" || intervalType == "week" || intervalType == "month") {
			out += " at the ";
			out += "<select name='intervalHour'>";
			for (var i=0; i < 24; i += 1){
				out += "<option value='" + i + "'>" + i;
			}
			out += "</select>";
			out += " hour ";
		}

		if (intervalType == "hour" || intervalType == "day" || intervalType == "week" || intervalType == "month") {
			out += " on the ";
			out += "<select name='intervalMin'>";
			for (var i=0; i < 60; i += 1){
				out += "<option value='" + i + "'>" + i;
			}
			out += "</select>";
			out += " minute ";
		}

		$("#intervalSettings").html(out);
	}

	$(document).ready(function() {

		if (checkVersion("4.5.0")) {
			$('#skipterms').show();
		}
		else {
			$('#skipterms').remove();			
		}

		if (checkVersion("4.5.1")) {
			$('#displayname').val("HXTool search: " + guid());
			$('#displayname_box').show();
		}
		else {
			$('#displayname').remove();			
		}
		
		$("#checkboxStore").click(function() {
			enableStore();
		});

		$("#checkboxFile").click(function() {
			enableFile();
		});

		$("#divStore").click(function() {
			enableStore();
		});

		$("#divFile").click(function() {
			enableFile();
		});

		$.fn.dataTable.ext.errMode = 'none';
		var es_datatable = $('#esTable').DataTable( {
			"ajax": "/api/v1/datatable_es",
			"paging":   false,
			"ordering": false,
			"info":     false,
			"searching": false,
			"processing": false,
			"columns": [
				{ "title": "id", "data": "DT_RowId" },
				{ "title": "state", "data": "state" },
				{ "title": "name", "data": "displayname" },
				{ "title": "mode", "data": "mode" },
				{ "title": "created", "data": "create_time" },
				{ "title": "updated", "data": "update_time" },
				{ "title": "user", "data": "create_actor" },
				{ "title": "type", "data": "input_type" },
				{ "title": "hostset", "data": "host_set" },
				{ "title": "hosts", "data": "stat_hosts" },
				{ "title": "skipped", "data": "stat_skipped_hosts" },
				{ "title": "", "data": "stat_new" },
				{ "title": "", "data": "stat_queued" },
				{ "title": "", "data": "stat_failed" },
				{ "title": "", "data": "stat_complete" },
				{ "title": "", "data": "stat_aborted" },
				{ "title": "", "data": "stat_cancelled" },
				{ "title": "", "data": "stat_searchstate_pending" },
				{ "title": "", "data": "stat_searchstate_matched" },
				{ "title": "", "data": "stat_searchstate_notmatched" },
				{ "title": "", "data": "stat_searchstate_error" },
				{ "title": "complete rate", "data": "stat_hosts" },
				{ "title": "action", "data": "DT_RowId" }

			],
			"headerCallback": function( thead, data, start, end, display ) {
				$(thead).find('th').eq(11).html('<div class="genericTableDivES">new</div>');
				$(thead).find('th').eq(12).html('<div class="genericTableDivES">queued</div>');
				$(thead).find('th').eq(13).html('<div class="genericTableDivES">failed</div>');
				$(thead).find('th').eq(14).html('<div class="genericTableDivES">complete</div>');
				$(thead).find('th').eq(15).html('<div class="genericTableDivES">aborted</div>');
				$(thead).find('th').eq(16).html('<div class="genericTableDivES">cancelled</div>');
				$(thead).find('th').eq(17).html('<div class="genericTableDivES">pending</div>');
				$(thead).find('th').eq(18).html('<div class="genericTableDivES">matched</div>');
				$(thead).find('th').eq(19).html('<div class="genericTableDivES">not matched</div>');
				$(thead).find('th').eq(20).html('<div class="genericTableDivES">error</div>');
			},
			"fnDrawCallback": function (oSettings) {
				$("div[id^='crate_']").each(function() {
					$(this).progress()
				});
			},
			"createdRow": function( row, data, index ) {
				$('td', row).eq(11).css( 'background-color', '#eeeeee' );
				$('td', row).eq(12).css( 'background-color', '#eeeeee' );
				$('td', row).eq(13).css( 'background-color', '#eeeeee' );
				$('td', row).eq(14).css( 'background-color', '#eeeeee' );
				$('td', row).eq(15).css( 'background-color', '#eeeeee' );
				$('td', row).eq(16).css( 'background-color', '#eeeeee' );
				$('td', row).eq(17).css( 'background-color', '#dddddd' );
				$('td', row).eq(18).css( 'background-color', '#dddddd' );
				$('td', row).eq(19).css( 'background-color', '#dddddd' );
				$('td', row).eq(20).css( 'background-color', '#dddddd' );
			},
			"columnDefs": [	
				{
				 "targets": [ 11, 12, 13, 14, 15, 16, 17, 18, 19, 20 ],
				 "width": "47px"
				},
				{
				 "targets": [ 4, 5 ],
				 render: function ( data, type, row, meta ) {
				 	return (datatables_Timestamp(data));
				 }
				},
				{
				 "targets": 21,
				 render: function ( data, type, row, meta ) {
				 	if(type === 'display') {
				 		if (data > 0) {
				 			myrate = (row.stat_complete / data) * 100;
				 		}
				 		else {
				 			myrate = 0;
				 		}
				 		data = "<div class='htMyBar htBarWrap'><div class='htBar' id='crate_" + row.DT_RowId + "' data-percent='" + Math.round(myrate) + "'></div></div>"
				 	}
				 	return data;
				 }
				},
				{
				 "targets": 22,
				 render: function ( data, type, row, meta ) {
				 	if(type === 'display') {
				 		myid = data;
				 		data = "<a class='tableActionButton' href='/searchaction?action=stop&id=" + myid + "'>stop</a>";
				 		data += "<a class='tableActionButton' href='/searchaction?action=remove&id=" + myid + "'>remove</a>";
				 	}
				 	return data;
				 }
				},
				{"className": "dt-center", "targets": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]}
			]
		});

		$('body').on('change','select',function(){

			if ($(this).attr('id') == "intervalMetric") {
				renderInterval($(this).val());
			}
		});

		jQuery('#scheduled_timestamp').daterangepicker({
			singleDatePicker: true,
			autoApply: true,
			timePicker: true,
			timePicker24Hour: true,
			buttonClasses: "tableActionButton",
			locale: {
     		 format: 'YYYY-MM-DD hh:mm:ss'
		    }
		});

		$('#esTable').on( 'click', 'tr', function () {
			window.document.location = "/searchresult?id=" + $(this).attr("id");
		});

		setInterval( function () {
			es_datatable.ajax.reload();
		}, 60000 );


	});
</script>

<form method='POST' action='/search' enctype="multipart/form-data">
	<div class='tableTitle'>
		<i class="fas fa-search fa-lg fa-fw" style='margin-right: 2px;' aria-hidden="true"></i>
		Search based on OpenIOC
	</div>
	<div class='inputArea' style='width: 600px;'>

		<div id='divStore' style='width: 250px; float: left; padding: 10px; margin-right: 15px; vertical-align: top; border: 1px solid rgb(215,215,215); border-radius: 5px; background: rgb(225,225,225);'>
			<input type='checkbox' name='store' id='checkboxStore' checked>
			<b>From HXTool</b><br><br>
			{% if openiocs %} {{ openiocs|safe }} {% endif %}
		</div>
		<div id='divFile' style='width: 250px; float: left; padding: 10px; vertical-align: top; border: 1px solid rgb(215,215,215); border-radius: 5px;'>
			<input type='checkbox' name='file' id='checkboxFile'>
			<b>From file</b><br><br>
			<input type='file' id='newioc' name='newioc'>
		</div>
		<div style='clear: both;'></div>

		<br>

		<div id='skipterms' style='display: none; margin-bottom: 10px;'>
			<b>Skip unsupported terms</b><br>
			<select name='esskipterms' id='esskipterms'>
				<option value='true'>True
				<option value='false'>False
			</select>
		</div>

		<div id='displayname_box' style='display: none; margin-bottom: 10px;'>
			<b>Display name</b><br>
			<input type='text' id='displayname' name='displayname' style='width: 350px;'>
		</div>

		<b>Hostset</b><br>
		<select name='sweephostset' id='sweephostset'>
			{% if hostsets %} {{ hostsets|safe }} {% endif %}
		</select>

		<br>
		<div style='border-bottom: 1px solid rgb(215,215,215); margin-bottom: 10px;'>&nbsp;</div>

		<input type='radio' name='schedule' value='run_now' checked><b> Run now</b><br>
		<input type='radio' name='schedule' value='run_at'><b> Run at specific date/time</b>
		<input type='text' id='scheduled_timestamp' name='scheduled_timestamp' style='margin-left: 5px;'>
		<br>
		<input type='radio' name='schedule' value='run_interval'><b> Run on an interval</b><br><br>
		<span style='margin-left: 15px;'>
			Every 
			<select name='intervalMetric' id='intervalMetric'>
				<option value='min'>Minute
				<option value='hour'>Hour
				<option value='day'>Day
				<option value='week'>Week
				<option value='month'>Month
			</select>
		</span>
		<span id='intervalSettings'></span>
		<br>
		<div style='border-bottom: 1px solid rgb(215,215,215); margin-bottom: 10px;'>&nbsp;</div>

		<div style='font-style: italic; margin-bottom: 15px; margin-top: 8px;'>Please note that the OpenIOC indicator must be in OpenIOC 1.1 format and use UTF-8 encoding without BOM.</div>
		<input class='tableActionButton' type='submit' value='Start Enterprise Search'>
	</div>
</form>

<br>

<div class='tableTitle'>
	<i class="fas fa-list-ul fa-lg fa-fw" style='margin-right: 2px;' aria-hidden="true"></i>
	Searches on the controller
</div>

<table class='genericTable genericTableES' id='esTable' style='width: 100%;'></table>

{% endblock %}
